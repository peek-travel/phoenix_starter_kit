#!/bin/bash

# Enable error handling
set -e

# Check if a friendly name was provided
if [ $# -lt 1 ]; then
  echo "Usage: $0 \"Friendly Name\""
  echo "Example: $0 \"Phoenix Starter Kit\""
  exit 1
fi

FRIENDLY_NAME="$1"

# Convert friendly name to different formats
# Convert to snake_case (lowercase with underscores)
SNAKE_CASE=$(echo "$FRIENDLY_NAME" | tr '[:upper:]' '[:lower:]' | sed 's/[^a-z0-9]/_/g' | sed 's/__*/_/g' | sed 's/^_//g' | sed 's/_$//g')

# Convert to UPPER_SNAKE_CASE (uppercase with underscores)
UPPER_SNAKE_CASE=$(echo "$FRIENDLY_NAME" | tr '[:lower:]' '[:upper:]' | sed 's/[^A-Z0-9]/_/g' | sed 's/__*/_/g' | sed 's/^_//g' | sed 's/_$//g')

# Convert to dash-case/kebab-case (lowercase with dashes)
DASH_CASE=$(echo "$FRIENDLY_NAME" | tr '[:upper:]' '[:lower:]' | sed 's/[^a-z0-9]/-/g' | sed 's/--*/-/g' | sed 's/^-//g' | sed 's/-$//g')

# Convert to PascalCase (CamelCase with first letter capitalized)
PASCAL_CASE=""
for word in $FRIENDLY_NAME; do
  word_capitalized="$(tr '[:lower:]' '[:upper:]' <<< ${word:0:1})${word:1}"
  PASCAL_CASE="${PASCAL_CASE}${word_capitalized}"
done

echo "Renaming project from 'Phoenix Starter Kit' to '$FRIENDLY_NAME'"
echo "Ensure you are on a clean branch with no changes before proceeding."
echo "Using formats:"
echo "  Friendly name: $FRIENDLY_NAME"
echo "  PascalCase: $PASCAL_CASE"
echo "  snake_case: $SNAKE_CASE"
echo "  UPPER_SNAKE_CASE: $UPPER_SNAKE_CASE"
echo "  dash-case: $DASH_CASE"
echo ""

# Confirm with the user
read -p "Continue with renaming? (y/n) " -n 1 -r
echo
if [[ ! $REPLY =~ ^[Yy]$ ]]; then
  echo "Renaming cancelled."
  exit 1
fi

# Function to handle errors
handle_error() {
  echo "Error occurred during renaming."
  exit 1
}

# Set trap for error handling
trap handle_error ERR

echo "Starting renaming process..."

# 1. Replace content in all files
echo "Replacing content in files..."
find . -type f -not -path "*/\.*" -not -path "*/deps/*" -not -path "*/node_modules/*" -not -path "*/priv/static/*" -not -path "*/_build/*" -exec grep -l "Phoenix Starter Kit\|PhoenixStarterKit\|PHOENIX_STARTER_KIT\|phoenix_starter_kit\|phoenix-starter-kit" {} \; 2>/dev/null | while read file; do
  echo "Processing file: $file"
  if [[ "$OSTYPE" == "darwin"* ]]; then
    # macOS requires an empty string after -i
    sed -i '' "s/PHOENIX_STARTER_KIT/$UPPER_SNAKE_CASE/g" "$file"
    sed -i '' "s/Phoenix Starter Kit/$FRIENDLY_NAME/g" "$file"
    sed -i '' "s/PhoenixStarterKit/$PASCAL_CASE/g" "$file"
    sed -i '' "s/phoenix_starter_kit/$SNAKE_CASE/g" "$file"
    sed -i '' "s/phoenix-starter-kit/$DASH_CASE/g" "$file"
  else
    # Linux doesn't need the empty string
    sed -i "s/PHOENIX_STARTER_KIT/$UPPER_SNAKE_CASE/g" "$file"
    sed -i "s/Phoenix Starter Kit/$FRIENDLY_NAME/g" "$file"
    sed -i "s/PhoenixStarterKit/$PASCAL_CASE/g" "$file"
    sed -i "s/phoenix_starter_kit/$SNAKE_CASE/g" "$file"
    sed -i "s/phoenix-starter-kit/$DASH_CASE/g" "$file"
  fi
done

# 2. Rename files with the slug in their name
echo "Renaming files..."
find . -type f \( -name "*phoenix_starter_kit*" -o -name "*phoenix-starter-kit*" \) -not -path "*/\.*" -not -path "*/deps/*" -not -path "*/node_modules/*" -not -path "*/_build/*" 2>/dev/null | while read file; do
  new_file=$(echo "$file" | sed "s/phoenix_starter_kit/$SNAKE_CASE/g" | sed "s/phoenix-starter-kit/$DASH_CASE/g")
  echo "Renaming file: $file -> $new_file"
  mkdir -p "$(dirname "$new_file")"
  mv "$file" "$new_file"
done

# 3. Rename directories with the slug in their name
echo "Renaming directories..."
find . -type d \( -name "*phoenix_starter_kit*" -o -name "*phoenix-starter-kit*" \) -not -path "*/\.*" -not -path "*/deps/*" -not -path "*/node_modules/*" -not -path "*/_build/*" 2>/dev/null | sort -r | while read dir; do
  new_dir=$(echo "$dir" | sed "s/phoenix_starter_kit/$SNAKE_CASE/g" | sed "s/phoenix-starter-kit/$DASH_CASE/g")
  echo "Renaming directory: $dir -> $new_dir"
  mkdir -p "$(dirname "$new_dir")"
  mv "$dir" "$new_dir"
done

echo "Renaming complete. Running checks..."

# Run bin/check to verify everything works
if bin/check; then
  echo "✅ Renaming successful! All checks passed."
else
  echo "❌ Checks failed after renaming."
  echo "Please try again with a different name or check the script for issues."
  exit 1
fi

echo ""
echo "Next steps:"
echo "1. Update your git remote if needed"
echo "2. Commit the changes: git add . && git commit -m \"Rename project to $FRIENDLY_NAME\""
echo ""
